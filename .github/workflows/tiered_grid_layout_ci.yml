name: Tiered Grid Layout CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - uses: actions/checkout@v3
      
      - name: Add PR Review Comment (Simulated)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.pull_request.number,
              body: "ğŸ‘‹ Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼: ã‚³ãƒ¼ãƒ‰å…¨ä½“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™"
            });

  setup:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Mint
        run: |
          brew install mint
          
      - name: Install dependencies via Mint
        run: |
          mint bootstrap

  lint-and-format:
    runs-on: macos-latest
    needs: setup  # setupã‚¸ãƒ§ãƒ–ã«ä¾å­˜
    
    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨Mintã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ 'setup' ã‚¸ãƒ§ãƒ–ã§è¡Œã‚ã‚Œã¾ã™
      
      - name: Show Tool Versions
        run: |
          mint run swiftlint version
          mint run swiftformat --version
          
      - name: Format Swift files
        run: |
          mint run swiftformat .
      
      - name: Run SwiftLint
        run: |
          mint run swiftlint lint --strict
          
      - name: Check for changes after linting (should be none)
        run: |
          git diff --exit-code || { echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ SwiftFormat ã¨ SwiftLint ã‚’å®Ÿè¡Œã—ã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"; exit 1; }
            
  build:
    runs-on: macos-latest
    needs: lint-and-format # setup ã‹ã‚‰ lint-and-format ã«å¤‰æ›´

    steps:
      # ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨Mintã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ 'setup' ã‚¸ãƒ§ãƒ–ã§è¡Œã‚ã‚Œã¾ã™

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Generate Xcode project
        run: |
          mint run xcodegen generate

      - name: Build Sample App
        run: |
          xcodebuild build -project TieredGridLayout.xcodeproj -scheme SampleApp -destination "platform=iOS Simulator,name=iPhone 15" | xcpretty